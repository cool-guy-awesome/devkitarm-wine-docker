name: Daily Build with File Tracking

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/devkitarm-wine-docker
  GHCR_IMAGE: ghcr.io/${{ github.repository }}

jobs:
  rebuild-if-needed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Get Remote SHA
        id: get-sha
        run: |

          curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 > regctl
          chmod +x regctl
          

          REMOTE_SHA=$(./regctl image digest devkitpro/devkitarm:latest --platform linux/amd64)
          echo "remote_sha=$REMOTE_SHA" >> $GITHUB_OUTPUT
          

          OLD_SHA=$(cat latest_sha.txt 2>/dev/null || echo "none")
          echo "old_sha=$OLD_SHA" >> $GITHUB_OUTPUT

      - name: Rebuild and Push
        if: steps.get-sha.outputs.remote_sha != steps.get-sha.outputs.old_sha
        run: |

          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          

          docker build -t ${{ env.DOCKER_IMAGE }}:latest -t ${{ env.GHCR_IMAGE }}:latest .
          docker push ${{ env.DOCKER_IMAGE }}:latest
          docker push ${{ env.GHCR_IMAGE }}:latest
          

          echo "${{ steps.get-sha.outputs.remote_sha }}" > latest_sha.txt

      - name: Commit SHA Update
        if: steps.get-sha.outputs.remote_sha != steps.get-sha.outputs.old_sha
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update tracked devkitarm SHA [skip ci]"
          file_pattern: 'latest_sha.txt'
